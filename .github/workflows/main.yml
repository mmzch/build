name: Build crDroid ROM for OnePlus 7T

on:
  workflow_dispatch:


jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device: [hotdogb]
    steps:
    - name: Setup Build Environment
      uses: actions/checkout@v3

    - name: Initialize and sync repo
      run: |
        sudo apt-get update
        sudo apt-get install openjdk-8-jdk -y
        sudo apt-get install curl -y
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo 'export PATH=~/bin:$PATH' >> ~/.bashrc
        export PATH=~/bin:$PATH
        source ~/.bashrc
        mkdir -p ~/rom
        cd ~/rom
        ~/bin/repo init -u https://github.com/crdroidandroid/android.git -b 11.0
        ~/bin/repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

    - name: Clone device, kernel, vendor trees
      run: |
        git clone https://github.com/crdroidandroid/android_device_oneplus_hotdogb.git -b 11.0 device/oneplus/hotdogb
        git clone https://github.com/crdroidandroid/android_kernel_oneplus_sm8150.git -b 11.0 kernel/oneplus/sm8150
        git clone https://github.com/crdroidandroid/proprietary_vendor_oneplus_sm8150-common.git -b 11.0 vendor/oneplus

    - name: Compile the ROM
      run: |
        . build/envsetup.sh
        lunch lineage_hotdogb-userdebug
        mka bacon -j$(nproc --all)
      env:
        USE_CCACHE: "1"
        CCACHE_DIR: "/tmp/ccache"
        CCACHE_EXEC: "/usr/bin/ccache"

    - name: Upload ROM to GitHub Releases
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: ROM
        path: out/target/product/hotdogb/*.zip
